# Fortune Cookie AI - 架构文档

> 自动生成时间: 2026-01-22

## 目录

- [系统概览](#系统概览)
- [前端架构](#前端架构)
- [后端架构](#后端架构)
- [数据架构](#数据架构)
- [安全架构](#安全架构)
- [性能架构](#性能架构)
- [部署架构](#部署架构)

---

## 系统概览

### 高层架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              客户端层                                        │
├─────────────────────────────────┬───────────────────────────────────────────┤
│           Web Browser           │              iOS App                       │
│       (Next.js SSR/CSR)         │          (Swift/SwiftUI)                  │
└─────────────────┬───────────────┴───────────────────┬───────────────────────┘
                  │                                   │
                  │ HTTPS                             │ HTTPS
                  │                                   │
┌─────────────────▼───────────────────────────────────▼───────────────────────┐
│                           边缘层 (Vercel Edge)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ Rate Limit  │  │    CORS     │  │     CSP     │  │ Edge Cache  │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
┌─────────────────────────────────────▼───────────────────────────────────────┐
│                          应用层 (Next.js 14)                                 │
├───────────────────────────────┬───────────────────┬─────────────────────────┤
│         API Routes            │   Server Pages    │    Client Pages         │
│    (Serverless Functions)     │  (SSR/SSG/ISR)    │    (React CSR)          │
└───────────────────────────────┴─────────┬─────────┴─────────────────────────┘
                                          │
┌─────────────────────────────────────────▼───────────────────────────────────┐
│                              服务层                                          │
├─────────────────┬─────────────────┬─────────────────┬───────────────────────┤
│   OpenRouter    │     Redis       │   PostgreSQL    │      NextAuth         │
│   (AI 生成)     │   (Upstash)     │   (Neon/Supabase)│    (认证)            │
│                 │                 │                 │                       │
│  ┌───────────┐  │  ┌───────────┐  │  ┌───────────┐  │  ┌─────────────────┐  │
│  │ GPT-4o-mini│  │  │ 缓存      │  │  │ Fortune   │  │  │ Google OAuth   │  │
│  │ Claude 3  │  │  │ 速率限制  │  │  │ User      │  │  │ Apple Sign In  │  │
│  │ Haiku     │  │  │ 会话      │  │  │ Analytics │  │  │ Mobile Auth    │  │
│  └───────────┘  │  └───────────┘  │  └───────────┘  │  └─────────────────┘  │
└─────────────────┴─────────────────┴─────────────────┴───────────────────────┘
```

### 技术选型理由

| 技术 | 选型理由 |
|------|----------|
| Next.js 14 | App Router、SSR/SSG 混合、API Routes、优秀的 SEO 支持 |
| PostgreSQL | 成熟稳定、Prisma 支持好、Vercel 生态兼容 |
| Upstash Redis | Serverless 友好、全球边缘分布、按需计费 |
| OpenRouter | 多模型支持、统一 API、成本优化 |
| Vercel | Next.js 原生支持、边缘部署、自动扩展 |

---

## 前端架构

### 渲染策略

```
┌─────────────────────────────────────────────────────────────────────┐
│                        页面渲染策略                                  │
├─────────────────┬─────────────────┬─────────────────────────────────┤
│      SSG        │       ISR       │           CSR                   │
│  (静态生成)      │  (增量再生)      │      (客户端渲染)               │
├─────────────────┼─────────────────┼─────────────────────────────────┤
│ - 首页          │ - 博客文章      │ - Generator 页面                │
│ - FAQ           │ - 分类页面      │ - 收藏页面                      │
│ - 隐私政策      │ - 标签页面      │ - 历史记录                      │
│ - 服务条款      │                 │ - 用户资料                      │
│ - 食谱页面      │                 │                                 │
└─────────────────┴─────────────────┴─────────────────────────────────┘
```

### 组件架构

```
components/
├── 核心组件
│   ├── AIFortuneCookie.tsx      # 主要交互组件
│   ├── FortuneCookie.tsx        # 基础展示组件
│   └── FortuneCookieInteractive.tsx
│
├── 布局组件
│   ├── Navigation.tsx           # 导航 (支持认证状态)
│   ├── Footer.tsx
│   ├── BackgroundEffects.tsx    # 动画背景
│   └── RouteProgress.tsx        # 路由进度
│
├── 功能模块
│   ├── generator/               # 生成器组件群
│   │   ├── ThemeSelector.tsx
│   │   ├── PersonalizationPanel.tsx
│   │   ├── GenerationResult/
│   │   └── HistoryTabs/
│   │
│   ├── messages/                # 消息组件群
│   │   ├── MessagesClientWrapper.tsx
│   │   ├── MessagesSearchFilter.tsx
│   │   └── MessageCategorySection.tsx
│   │
│   └── homepage/                # 首页组件群
│       ├── HotFortuneCarousel.tsx
│       ├── CategoryQuickLinks.tsx
│       └── UseCaseScenes.tsx
│
├── SEO 组件
│   ├── SEO.tsx                  # 元数据
│   ├── StructuredData.tsx       # JSON-LD
│   └── FAQStructuredData.tsx
│
└── ui/                          # shadcn/ui 基础组件
    ├── button.tsx
    ├── card.tsx
    ├── input.tsx
    └── ...
```

### 状态管理

```
┌─────────────────────────────────────────────────────────────────────┐
│                         状态管理策略                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐ │
│  │   Server State  │    │   URL State     │    │   Local State   │ │
│  │   (服务器状态)   │    │   (URL 状态)     │    │   (本地状态)    │ │
│  ├─────────────────┤    ├─────────────────┤    ├─────────────────┤ │
│  │ - NextAuth      │    │ - 路由参数      │    │ - useState      │ │
│  │ - Server        │    │ - 搜索参数      │    │ - useReducer    │ │
│  │   Components    │    │ - 分页状态      │    │ - LocalStorage  │ │
│  │ - API 数据      │    │                 │    │                 │ │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘ │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    Context Providers                         │   │
│  ├─────────────────────────────────────────────────────────────┤   │
│  │ - SessionProvider (NextAuth)                                │   │
│  │ - ThemeProvider (主题)                                       │   │
│  │ - ToastProvider (Sonner)                                    │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 后端架构

### API 路由结构

```
app/api/
├── fortune/
│   ├── route.ts              # POST: AI 生成 Fortune
│   └── quota/
│       └── route.ts          # GET: 配额状态
│
├── fortunes/
│   └── route.ts              # GET: 浏览预置消息
│
├── auth/
│   ├── [...nextauth]/
│   │   └── route.ts          # NextAuth 路由
│   ├── session/
│   │   └── route.ts          # 统一会话验证
│   └── mobile/
│       ├── apple/
│       │   └── route.ts      # Apple Sign In
│       ├── google/
│       │   └── route.ts      # Google Sign In
│       └── session/
│           └── route.ts      # 移动端会话
│
├── favorites/
│   └── route.ts              # 收藏 CRUD
│
├── analytics/
│   ├── route.ts              # 事件上报
│   ├── web-vitals/
│   │   └── route.ts          # Web Vitals
│   └── dashboard/
│       └── route.ts          # 仪表板数据
│
├── database/
│   └── route.ts              # 健康检查
│
├── cache/
│   └── route.ts              # 缓存管理
│
└── indexnow/
    └── route.ts              # 搜索引擎通知
```

### 核心服务层

```
lib/
├── AI 服务
│   ├── openrouter.ts         # OpenRouter 客户端
│   │   └── OpenRouterClient
│   │       ├── generateFortune()
│   │       ├── generateLuckyNumbers()
│   │       ├── getFallbackFortune()
│   │       └── healthCheck()
│   │
│   └── fortune-database.ts   # 预置消息数据库
│       ├── fortuneDatabase (500+ 消息)
│       ├── searchFortunes()
│       ├── getFortunesByCategory()
│       └── getDiverseFortunesByCategory()
│
├── 缓存服务
│   ├── redis-cache.ts        # Redis 缓存
│   │   └── CacheManager
│   │       ├── cacheFortune() / getCachedFortune()
│   │       ├── cacheApiResponse() / getCachedApiResponse()
│   │       └── rateLimiters (5 个限制器)
│   │
│   └── edge-cache.ts         # 边缘缓存
│       ├── EdgeCacheManager
│       ├── CachePerformanceMonitor
│       └── CacheWarmupManager
│
├── 认证服务
│   ├── auth.ts               # NextAuth 配置
│   ├── auth-client.ts        # 客户端钩子
│   │   ├── useAuthSession()
│   │   ├── startGoogleSignIn()
│   │   └── startSignOut()
│   │
│   └── mobile-auth.ts        # 移动端认证
│       ├── verifyAppleToken()
│       ├── verifyGoogleToken()
│       ├── createMobileSession()
│       └── validateMobileSession()
│
├── 配额服务
│   └── quota.ts
│       ├── getDailyQuotaStatus()
│       ├── consumeDailyQuota()
│       ├── recordFortuneUsage()
│       └── resolveGuestId()
│
└── 监控服务
    ├── error-monitoring.ts   # 错误监控
    │   └── ErrorMonitor
    │       ├── captureError()
    │       ├── captureApiError()
    │       └── captureUserAction()
    │
    ├── analytics-manager.ts  # 分析管理
    └── session-manager.ts    # 会话管理
```

### AI 生成流程

```
┌───────────────┐
│  POST /api/   │
│   fortune     │
└───────┬───────┘
        │
        ▼
┌───────────────┐     ┌───────────────┐
│ 输入验证      │────▶│ 主题/情绪/    │
│ & 清洗        │     │ 长度验证      │
└───────┬───────┘     └───────────────┘
        │
        ▼
┌───────────────┐     ┌───────────────┐
│ 认证检查      │────▶│ 配额检查      │
│ (可选)        │     │               │
└───────┬───────┘     └───────┬───────┘
        │                     │
        │              ┌──────▼──────┐
        │              │ 配额不足?   │─────Yes────▶ 返回 429
        │              └──────┬──────┘
        │                     │ No
        ▼                     ▼
┌───────────────┐     ┌───────────────┐
│ 缓存检查      │────▶│ 缓存命中?    │─────Yes────▶ 返回缓存
│ (Redis)       │     └───────┬───────┘
└───────────────┘             │ No
                              ▼
                    ┌───────────────┐
                    │ OpenRouter    │
                    │ API 调用      │
                    └───────┬───────┘
                            │
              ┌─────────────┴─────────────┐
              │                           │
              ▼                           ▼
      ┌─────────────┐             ┌─────────────┐
      │ 成功        │             │ 失败        │
      └──────┬──────┘             └──────┬──────┘
             │                           │
             ▼                           ▼
      ┌─────────────┐             ┌─────────────┐
      │ 缓存结果    │             │ 回退到      │
      │ (5min)      │             │ 预置数据库  │
      └──────┬──────┘             └──────┬──────┘
             │                           │
             └─────────────┬─────────────┘
                           ▼
                   ┌─────────────┐
                   │ 记录使用量  │
                   │ & 分析      │
                   └──────┬──────┘
                          │
                          ▼
                   ┌─────────────┐
                   │ 返回响应    │
                   │ (带配额信息)│
                   └─────────────┘
```

---

## 数据架构

### 数据库模型关系

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据模型关系图                                  │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────┐
                    │    User     │
                    │ (auth_users)│
                    └──────┬──────┘
                           │
           ┌───────────────┼───────────────┬───────────────┐
           │               │               │               │
           ▼               ▼               ▼               ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │   Account   │ │   Session   │ │ MobileSession│ │  Favorite   │
    │(auth_accounts)│ │(auth_sessions)│ │(mobile_sessions)│ │ (favorites) │
    └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
                           │               │               │
                           │               │               │
                           ▼               ▼               ▼
                    ┌─────────────────────────────────────────┐
                    │              FortuneQuota               │
                    │            (fortune_quota)              │
                    │         userId OR guestId + dateKey     │
                    └───────────────────┬─────────────────────┘
                                        │
                                        ▼
                    ┌─────────────────────────────────────────┐
                    │              FortuneUsage               │
                    │            (fortune_usage)              │
                    │        使用历史记录 (可选关联用户)        │
                    └─────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                              独立模型                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Fortune   │  │ UserSession │  │  ApiUsage   │  │  WebVital   │        │
│  │ (fortunes)  │  │(user_sessions)│ │ (api_usage) │  │(web_vitals) │        │
│  │ 预置消息    │  │ 会话追踪    │  │ API 使用    │  │ 性能指标    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
│                                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                         │
│  │  ErrorLog   │  │ CacheStats  │  │UserFeedback │                         │
│  │(error_logs) │  │(cache_stats)│  │(user_feedback)│                        │
│  │ 错误日志    │  │ 缓存统计    │  │ 用户反馈    │                         │
│  └─────────────┘  └─────────────┘  └─────────────┘                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 缓存架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              三层缓存架构                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Layer 1: Edge Cache (CDN + Browser)                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                     │   │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │   │
│  │  │  Static Assets   │  │  API Responses   │  │  Browser Cache   │  │   │
│  │  │  (max-age: 1y)   │  │  (s-maxage: 5m)  │  │  (Cache-Control) │  │   │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘  │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                       │
│                                    ▼                                       │
│  Layer 2: Redis Cache (Upstash)                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                     │   │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │   │
│  │  │  Fortune Cache   │  │  Rate Limiters   │  │  Session Data    │  │   │
│  │  │  (TTL: 5min)     │  │  (Sliding Window)│  │  (TTL: 24h)      │  │   │
│  │  │                  │  │                  │  │                  │  │   │
│  │  │  Key Format:     │  │  - api (100/10s) │  │  Key Format:     │  │   │
│  │  │  fortune:{hash}  │  │  - fortune(20/10s)│  │  session:{id}   │  │   │
│  │  │                  │  │  - search(50/10s)│  │                  │  │   │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘  │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                       │
│                                    ▼                                       │
│  Layer 3: Database (PostgreSQL)                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                     │   │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │   │
│  │  │  Fortune Data    │  │  User Data       │  │  Analytics Data  │  │   │
│  │  │  (500+ 预置)     │  │  (认证/配额)     │  │  (性能/错误)     │  │   │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘  │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 安全架构

### 安全层次

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              安全架构                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 传输层安全                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  - HTTPS 强制 (Vercel 自动)                                          │   │
│  │  - HSTS Header                                                       │   │
│  │  - TLS 1.3                                                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  2. 应用层安全 (middleware.ts)                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  - CSP (Content Security Policy) with Nonce                         │   │
│  │  - CORS 配置                                                         │   │
│  │  - X-Frame-Options: DENY                                             │   │
│  │  - X-Content-Type-Options: nosniff                                   │   │
│  │  - Referrer-Policy: strict-origin-when-cross-origin                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  3. API 安全                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  - 速率限制 (Upstash Ratelimit)                                      │   │
│  │  - 输入验证和清洗                                                    │   │
│  │  - Prompt 注入防护                                                   │   │
│  │  - SQL 注入防护 (Prisma ORM)                                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  4. 认证安全                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  - OAuth 2.0 (Google)                                                │   │
│  │  - Apple Sign In with JWKS                                           │   │
│  │  - 安全的 Session Token 生成                                         │   │
│  │  - CSRF 防护 (NextAuth)                                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  5. 数据安全                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  - 环境变量加密存储                                                  │   │
│  │  - 数据库连接 SSL                                                    │   │
│  │  - 敏感数据最小化存储                                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 输入验证流程

```
用户输入
    │
    ▼
┌───────────────┐
│ 长度限制检查  │ ──── 超过限制 ──▶ 400 Bad Request
│ (200 chars)   │
└───────┬───────┘
        │
        ▼
┌───────────────┐
│ HTML 标签清理 │ ──── 移除所有 HTML
└───────┬───────┘
        │
        ▼
┌───────────────┐
│ Script 注入   │ ──── 检测并拒绝
│ 检测          │
└───────┬───────┘
        │
        ▼
┌───────────────┐
│ Prompt 注入   │ ──── 检测恶意模式
│ 检测          │
└───────┬───────┘
        │
        ▼
┌───────────────┐
│ 白名单验证    │ ──── theme/mood/length
│ (枚举值)      │
└───────┬───────┘
        │
        ▼
    清洗后的输入
```

---

## 性能架构

### 性能优化策略

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              性能优化策略                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 首屏优化 (LCP < 2.5s)                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  - SSG 静态生成关键页面                                              │   │
│  │  - 关键 CSS 内联 (CriticalCSS 组件)                                  │   │
│  │  - 字体预加载                                                        │   │
│  │  - 图片 CDN (Vercel Blob)                                            │   │
│  │  - AdSense 延迟加载 (AdSenseFacade)                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  2. 交互优化 (INP < 200ms)                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  - 组件懒加载 (dynamic import)                                       │   │
│  │  - 事件处理防抖/节流                                                 │   │
│  │  - Web Worker 卸载计算                                               │   │
│  │  - 乐观更新 UI                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  3. 布局稳定性 (CLS < 0.1)                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  - 固定尺寸骨架屏                                                    │   │
│  │  - 图片宽高比设定                                                    │   │
│  │  - 字体显示策略 (font-display: swap)                                 │   │
│  │  - 广告位预留空间                                                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  4. 网络优化                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  - HTTP/2 多路复用                                                   │   │
│  │  - Brotli/Gzip 压缩                                                  │   │
│  │  - 预连接 (dns-prefetch, preconnect)                                 │   │
│  │  - Service Worker 离线缓存                                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 性能监控

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              性能监控流程                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐                                                           │
│  │ 浏览器      │                                                           │
│  │ web-vitals  │                                                           │
│  └──────┬──────┘                                                           │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                  │
│  │ Performance │────▶│ 聚合       │────▶│ 持久化      │                  │
│  │ Monitor    │     │ & 评级      │     │ (WebVital)  │                  │
│  │ (组件)      │     │             │     │             │                  │
│  └─────────────┘     └─────────────┘     └─────────────┘                  │
│                                                │                           │
│                                                ▼                           │
│                                         ┌─────────────┐                    │
│                                         │ 分析仪表板 │                    │
│                                         │ (Dashboard) │                    │
│                                         └─────────────┘                    │
│                                                                             │
│  监控指标:                                                                  │
│  ┌────────────┬────────────┬────────────┬────────────┬────────────┐       │
│  │    LCP     │    INP     │    CLS     │    FCP     │   TTFB     │       │
│  │  < 2.5s   │  < 200ms   │   < 0.1    │  < 1.8s   │  < 800ms   │       │
│  └────────────┴────────────┴────────────┴────────────┴────────────┘       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 部署架构

### Vercel 部署

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Vercel 部署架构                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Vercel Edge Network                          │   │
│  │                        (全球 CDN 节点)                               │   │
│  └────────────────────────────────┬────────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Vercel Functions                             │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │   │
│  │  │ API Routes  │  │ Server      │  │ Middleware  │                  │   │
│  │  │ (Serverless)│  │ Components  │  │ (Edge)      │                  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                           外部服务                                   │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │   │
│  │  │ PostgreSQL  │  │   Upstash   │  │ OpenRouter  │                  │   │
│  │  │ (Neon)      │  │   Redis     │  │   API       │                  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### CI/CD 流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ Git Push    │────▶│ Type Check  │────▶│   Build     │────▶│   Deploy    │
│             │     │ & Lint      │     │             │     │   (Vercel)  │
└─────────────┘     └─────────────┘     └─────────────┘     └──────┬──────┘
                                                                   │
                                                                   ▼
                                                           ┌─────────────┐
                                                           │ Deployment  │
                                                           │ Checks      │
                                                           └─────────────┘

验证步骤:
1. npm run type-check (TypeScript 类型检查)
2. npm run lint (ESLint)
3. prisma generate (生成 Prisma Client)
4. next build (生产构建)
5. 部署到 Vercel Preview/Production
6. npm run test:deployment (健康检查)
```

---

*此文档由 Claude Code 自动生成，基于项目架构分析。*
